generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Company {
  id                            Int                          @id @default(autoincrement())
  name                          String
  createdAt                     DateTime                     @default(now())
  updatedAt                     DateTime                     @updatedAt
  accountsReceivableAccountId   Int?
  accountsPayableAccountId      Int?
  inventoryAssetAccountId       Int?
  cogsAccountId                 Int?
  openingBalanceEquityAccountId Int?
  goodsReceivedNotInvoicedAccountId Int?
  purchasePriceVarianceAccountId Int?
  defaultLocationId             Int?                         @map("defaultWarehouseId")
  baseCurrency                  String?
  timeZone                      String?
  fiscalYearStartMonth          Int?                         @default(1)
  invoiceTemplate               Json?
  paymentQrCodes                Json?
  accounts                      Account[]
  accountBalances               AccountBalance[]
  auditLogs                     AuditLog[]
  bankingAccounts               BankingAccount[]
  accountsPayableAccount        Account?                     @relation("Company_AP", fields: [accountsPayableAccountId], references: [id])
  accountsReceivableAccount     Account?                     @relation("Company_AR", fields: [accountsReceivableAccountId], references: [id])
  cogsAccount                   Account?                     @relation("Company_COGS", fields: [cogsAccountId], references: [id])
  defaultLocation               Location?                    @relation("Company_DefaultLocation", fields: [defaultLocationId], references: [id])
  inventoryAssetAccount         Account?                     @relation("Company_InventoryAsset", fields: [inventoryAssetAccountId], references: [id])
  openingBalanceEquityAccount   Account?                     @relation("Company_OpeningEquity", fields: [openingBalanceEquityAccountId], references: [id])
  goodsReceivedNotInvoicedAccount Account?                   @relation("Company_GRNI", fields: [goodsReceivedNotInvoicedAccountId], references: [id])
  purchasePriceVarianceAccount  Account?                     @relation("Company_PPV", fields: [purchasePriceVarianceAccountId], references: [id])
  creditNotes                   CreditNote[]
  creditNoteLines               CreditNoteLine[]
  creditNoteRefunds             CreditNoteRefund[]
  currencies                    Currency[]
  customers                     Customer[]
  customerAdvances              CustomerAdvance[]
  customerAdvanceApplications   CustomerAdvanceApplication[]
  summaries                     DailySummary[]
  documentSequences             DocumentSequence[]
  events                        Event[]
  exchangeRates                 ExchangeRate[]
  expenses                      Expense[]
  expensePayments               ExpensePayment[]
  idempotentRequests            IdempotentRequest[]
  integrationEntityMaps         IntegrationEntityMap[]
  invoices                      Invoice[]
  invoiceLines                  InvoiceLine[]
  items                         Item[]
  entries                       JournalEntry[]
  journalLines                  JournalLine[]
  payments                      Payment[]
  periodCloses                  PeriodClose[]
  processedEvents               ProcessedEvent[]
  purchaseBills                 PurchaseBill[]
  purchaseBillLines             PurchaseBillLine[]
  purchaseBillPayments          PurchaseBillPayment[]
  purchaseReceipts              PurchaseReceipt[]
  purchaseReceiptLines          PurchaseReceiptLine[]
  purchaseBillLandedCostAllocations PurchaseBillLandedCostAllocation[]
  stockBalances                 StockBalance[]
  stockMoves                    StockMove[]
  taxGroups                     TaxGroup[]
  taxRates                      TaxRate[]
  users                         User[]
  vendors                       Vendor[]
  vendorAdvances                VendorAdvance[]
  vendorAdvanceApplications     VendorAdvanceApplication[]
  vendorCredits                 VendorCredit[]
  vendorCreditApplications      VendorCreditApplication[]
  vendorCreditLines             VendorCreditLine[]
  purchaseOrders                PurchaseOrder[]
  purchaseOrderLines            PurchaseOrderLine[]
  locations                     Location[]
  inventoryRecalcState          InventoryRecalcState?
  journalEntryInventoryValuations JournalEntryInventoryValuation[]

  @@index([accountsPayableAccountId], map: "Company_accountsPayableAccountId_fkey")
  @@index([accountsReceivableAccountId], map: "Company_accountsReceivableAccountId_fkey")
  @@index([cogsAccountId], map: "Company_cogsAccountId_fkey")
  @@index([defaultLocationId], map: "Company_defaultWarehouseId_fkey")
  @@index([inventoryAssetAccountId], map: "Company_inventoryAssetAccountId_fkey")
  @@index([openingBalanceEquityAccountId], map: "Company_openingBalanceEquityAccountId_fkey")
  @@index([goodsReceivedNotInvoicedAccountId], map: "Company_goodsReceivedNotInvoicedAccountId_fkey")
  @@index([purchasePriceVarianceAccountId], map: "Company_purchasePriceVarianceAccountId_fkey")
}

model Account {
  id                                Int                   @id @default(autoincrement())
  companyId                         Int
  code                              String
  name                              String
  type                              AccountType
  isActive                          Boolean               @default(true)
  createdAt                         DateTime              @default(now())
  updatedAt                         DateTime              @updatedAt
  normalBalance                     NormalBalance         @default(DEBIT)
  reportGroup                       AccountReportGroup?
  cashflowActivity                  CashflowActivity?
  company                           Company               @relation(fields: [companyId], references: [id])
  balances                          AccountBalance[]
  bankingAccount                    BankingAccount?
  accountsPayableFor                Company[]             @relation("Company_AP")
  accountsReceivableFor             Company[]             @relation("Company_AR")
  cogsFor                           Company[]             @relation("Company_COGS")
  inventoryAssetFor                 Company[]             @relation("Company_InventoryAsset")
  openingBalanceEquityFor           Company[]             @relation("Company_OpeningEquity")
  creditNoteLinesIncome             CreditNoteLine[]      @relation("CreditNoteLine_IncomeAccount")
  creditNoteRefundBankMovements     CreditNoteRefund[]    @relation("CreditNoteRefund_BankAccount")
  customerAdvanceBankMovements      CustomerAdvance[]     @relation("CustomerAdvance_BankAccount")
  customerAdvanceLiabilityMovements CustomerAdvance[]     @relation("CustomerAdvance_LiabilityAccount")
  expenses                          Expense[]             @relation("Expense_ExpenseAccount")
  bankExpensePayments               ExpensePayment[]      @relation("ExpensePayment_BankAccount")
  invoiceLinesIncome                InvoiceLine[]         @relation("InvoiceLine_IncomeAccount")
  expenseItems                      Item[]                @relation("Account_ExpenseItems")
  incomeItems                       Item[]                @relation("Account_IncomeItems")
  lines                             JournalLine[]
  bankPayments                      Payment[]             @relation("Payment_BankAccount")
  purchaseBillLines                 PurchaseBillLine[]
  purchaseBillPayments              PurchaseBillPayment[] @relation("PurchaseBillPayment_BankAccount")
  vendorAdvanceBankMovements        VendorAdvance[]       @relation("VendorAdvance_BankAccount")
  vendorAdvancePrepaymentMovements  VendorAdvance[]       @relation("VendorAdvance_PrepaymentAccount")
  vendorCreditLines                 VendorCreditLine[]    @relation("VendorCreditLine_Account")
  goodsReceivedNotInvoicedFor       Company[]             @relation("Company_GRNI")
  purchasePriceVarianceFor          Company[]             @relation("Company_PPV")

  @@unique([companyId, code])
}

model AccountBalance {
  id          Int      @id @default(autoincrement())
  companyId   Int
  accountId   Int
  date        DateTime
  debitTotal  Decimal  @db.Decimal(18, 2)
  creditTotal Decimal  @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  account     Account  @relation(fields: [accountId], references: [id])
  company     Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, accountId, date])
  @@index([companyId, date])
  @@index([companyId, accountId])
  @@index([accountId], map: "AccountBalance_accountId_fkey")
}

model BankingAccount {
  id             Int                @id @default(autoincrement())
  companyId      Int
  accountId      Int                @unique
  kind           BankingAccountKind
  currency       String?            @db.VarChar(3)
  bankName       String?
  accountNumber  String?
  identifierCode String?
  branch         String?
  description    String?            @db.Text
  isPrimary      Boolean            @default(false)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  account        Account            @relation(fields: [accountId], references: [id])
  company        Company            @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model JournalEntry {
  id                            Int                         @id @default(autoincrement())
  companyId                     Int
  date                          DateTime
  description                   String
  createdAt                     DateTime                    @default(now())
  updatedAt                     DateTime                    @updatedAt
  createdByUserId               Int?
  postedAt                      DateTime                    @default(now())
  reversalOfJournalEntryId      Int?                        @unique
  reversalReason                String?                     @db.Text
  entryNumber                   String?                     @db.VarChar(32)
  voidedAt                      DateTime?
  voidReason                    String?                     @db.Text
  voidedByUserId                Int?
  updatedByUserId               Int?
  locationId                    Int?                        @map("warehouseId")
  creditNote                    CreditNote?                 @relation("CreditNote_JournalEntry")
  creditNoteLastAdjustmentFor   CreditNote[]                @relation("CreditNote_LastAdjustmentJournalEntry")
  creditNoteVoidFor             CreditNote?                 @relation("CreditNote_VoidJournalEntry")
  creditNoteRefund              CreditNoteRefund?           @relation("CreditNoteRefund_JournalEntry")
  customerAdvance               CustomerAdvance?            @relation("CustomerAdvance_JournalEntry")
  customerAdvanceApplication    CustomerAdvanceApplication? @relation("CustomerAdvanceApplication_JournalEntry")
  expense                       Expense?                    @relation("Expense_JournalEntry")
  expenseLastAdjustmentFor      Expense[]                   @relation("Expense_LastAdjustmentJournalEntry")
  expenseVoidFor                Expense?                    @relation("Expense_VoidJournalEntry")
  expensePayment                ExpensePayment?             @relation("ExpensePayment_JournalEntry")
  expensePaymentReversal        ExpensePayment?             @relation("ExpensePayment_ReversalJournalEntry")
  invoice                       Invoice?                    @relation("Invoice_JournalEntry")
  invoiceLastAdjustmentFor      Invoice[]                   @relation("Invoice_LastAdjustmentJournalEntry")
  invoiceVoidFor                Invoice?                    @relation("Invoice_VoidJournalEntry")
  location                      Location?                   @relation(fields: [locationId], references: [id], map: "JE_wh_fk")
  company                       Company                     @relation(fields: [companyId], references: [id])
  createdByUser                 User?                       @relation(fields: [createdByUserId], references: [id])
  reversalOfJournalEntry        JournalEntry?               @relation("JournalEntry_Reversal", fields: [reversalOfJournalEntryId], references: [id])
  reversalEntry                 JournalEntry?               @relation("JournalEntry_Reversal")
  updatedByUser                 User?                       @relation("User_UpdatedJournalEntries", fields: [updatedByUserId], references: [id])
  voidedByUser                  User?                       @relation("User_VoidedJournalEntries", fields: [voidedByUserId], references: [id])
  lines                         JournalLine[]
  payment                       Payment?                    @relation("Payment_JournalEntry")
  paymentReversal               Payment?                    @relation("Payment_ReversalJournalEntry")
  periodClose                   PeriodClose?
  purchaseBill                  PurchaseBill?
  purchaseBillLastAdjustmentFor PurchaseBill[]              @relation("PurchaseBill_LastAdjustmentJournalEntry")
  purchaseBillVoidFor           PurchaseBill?               @relation("PurchaseBill_VoidJournalEntry")
  purchaseBillPayment           PurchaseBillPayment?        @relation("PurchaseBillPayment_JournalEntry")
  purchaseBillPaymentReversal   PurchaseBillPayment?        @relation("PurchaseBillPayment_ReversalJournalEntry")
  purchaseReceipt               PurchaseReceipt?            @relation("PurchaseReceipt_JournalEntry")
  purchaseReceiptVoidFor        PurchaseReceipt?            @relation("PurchaseReceipt_VoidJournalEntry")
  vendorAdvance                 VendorAdvance?              @relation("VendorAdvance_JournalEntry")
  vendorAdvanceApplication      VendorAdvanceApplication?   @relation("VendorAdvanceApplication_JournalEntry")
  vendorCredit                  VendorCredit?               @relation("VendorCredit_JournalEntry")
  vendorCreditLastAdjustmentFor VendorCredit[]              @relation("VendorCredit_LastAdjustmentJournalEntry")
  vendorCreditVoidFor           VendorCredit?               @relation("VendorCredit_VoidJournalEntry")
  journalEntryInventoryValuations JournalEntryInventoryValuation[]

  @@unique([companyId, entryNumber])
  @@index([companyId, date])
  @@index([companyId, locationId], map: "JE_co_wh_idx")
  @@index([locationId], map: "JE_wh_idx")
  @@index([createdByUserId], map: "JournalEntry_createdByUserId_fkey")
  @@index([updatedByUserId], map: "JournalEntry_updatedByUserId_fkey")
  @@index([voidedByUserId], map: "JournalEntry_voidedByUserId_fkey")
}

model JournalLine {
  id             Int          @id @default(autoincrement())
  journalEntryId Int
  accountId      Int
  debit          Decimal      @db.Decimal(18, 2)
  credit         Decimal      @db.Decimal(18, 2)
  companyId      Int
  account        Account      @relation(fields: [accountId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id])
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])

  @@index([companyId])
  @@index([accountId], map: "JournalLine_accountId_fkey")
  @@index([journalEntryId], map: "JournalLine_journalEntryId_fkey")
}

model Event {
  id                   Int       @id @default(autoincrement())
  companyId            Int?
  type                 String
  payload              Json
  createdAt            DateTime  @default(now())
  eventId              String    @unique
  eventType            String
  schemaVersion        String
  occurredAt           DateTime  @default(now())
  source               String?
  partitionKey         String?
  correlationId        String?
  causationId          String?
  aggregateType        String?
  aggregateId          String?
  publishedAt          DateTime?
  nextPublishAttemptAt DateTime? @default(now())
  publishAttempts      Int       @default(0)
  lastPublishError     String?   @db.Text
  lockedAt             DateTime?
  lockId               String?
  company              Company?  @relation(fields: [companyId], references: [id])

  @@index([publishedAt, nextPublishAttemptAt])
  @@index([lockedAt])
  @@index([companyId, occurredAt])
}

model ProcessedEvent {
  id          Int      @id @default(autoincrement())
  eventId     String   @unique
  processedAt DateTime @default(now())
  companyId   Int
  company     Company  @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model DailySummary {
  id           Int      @id @default(autoincrement())
  companyId    Int
  date         DateTime
  totalIncome  Decimal  @db.Decimal(18, 2)
  totalExpense Decimal  @db.Decimal(18, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, date])
}

model Customer {
  id               Int               @id @default(autoincrement())
  companyId        Int
  name             String
  email            String?
  phone            String?
  currency         String?
  openingBalance   Decimal?          @db.Decimal(18, 2)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  creditNotes      CreditNote[]
  company          Company           @relation(fields: [companyId], references: [id])
  customerAdvances CustomerAdvance[]
  invoices         Invoice[]

  @@index([companyId])
}

model Item {
  id                Int                      @id @default(autoincrement())
  companyId         Int
  name              String
  sku               String?
  type              ItemType
  sellingPrice      Decimal                  @db.Decimal(18, 2)
  costPrice         Decimal?                 @db.Decimal(18, 2)
  incomeAccountId   Int
  expenseAccountId  Int?
  isActive          Boolean                  @default(true)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  trackInventory    Boolean                  @default(false)
  valuationMethod   InventoryValuationMethod @default(WAC)
  defaultLocationId Int?                     @map("defaultWarehouseId")
  creditNoteLines   CreditNoteLine[]
  expenses          Expense[]
  invoiceLines      InvoiceLine[]
  company           Company                  @relation(fields: [companyId], references: [id])
  defaultLocation   Location?                @relation(fields: [defaultLocationId], references: [id])
  expenseAccount    Account?                 @relation("Account_ExpenseItems", fields: [expenseAccountId], references: [id])
  incomeAccount     Account                  @relation("Account_IncomeItems", fields: [incomeAccountId], references: [id])
  purchaseBillLines PurchaseBillLine[]
  purchaseOrderLines PurchaseOrderLine[]
  purchaseReceiptLines PurchaseReceiptLine[]
  stockBalances     StockBalance[]
  stockMoves        StockMove[]
  vendorCreditLines VendorCreditLine[]

  @@index([companyId])
  @@index([defaultLocationId], map: "Item_defaultWarehouseId_fkey")
  @@index([expenseAccountId], map: "Item_expenseAccountId_fkey")
  @@index([incomeAccountId], map: "Item_incomeAccountId_fkey")
}

model Location {
  id                  Int                @id @default(autoincrement())
  companyId           Int
  name                String
  isDefault           Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  defaultForCompanies Company[]          @relation("Company_DefaultLocation")
  customerAdvances    CustomerAdvance[]  @relation("CustomerAdvance_Location")
  invoices            Invoice[]
  items               Item[]
  journalEntries      JournalEntry[]
  purchaseBills       PurchaseBill[]
  purchaseBillLines   PurchaseBillLine[]
  purchaseOrders      PurchaseOrder[]
  purchaseOrderLines  PurchaseOrderLine[]
  purchaseReceipts    PurchaseReceipt[]
  purchaseReceiptLines PurchaseReceiptLine[]
  stockBalances       StockBalance[]
  stockMoves          StockMove[]
  vendorAdvances      VendorAdvance[]
  vendorCredits       VendorCredit[]     @relation("VendorCredit_Location")
  vendorCreditLines   VendorCreditLine[] @relation("VendorCreditLine_Location")
  company             Company            @relation(fields: [companyId], references: [id])

  @@unique([companyId, name])
  @@index([companyId])
  @@map("Warehouse")
}

model StockBalance {
  id             Int      @id @default(autoincrement())
  companyId      Int
  locationId     Int      @map("warehouseId")
  itemId         Int
  qtyOnHand      Decimal  @db.Decimal(18, 2)
  avgUnitCost    Decimal  @db.Decimal(18, 2)
  inventoryValue Decimal  @db.Decimal(18, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  company        Company  @relation(fields: [companyId], references: [id])
  item           Item     @relation(fields: [itemId], references: [id])
  location       Location @relation(fields: [locationId], references: [id])

  @@unique([companyId, locationId, itemId])
  @@index([companyId, itemId])
  @@index([companyId, locationId])
  @@index([itemId], map: "StockBalance_itemId_fkey")
  @@index([locationId], map: "StockBalance_warehouseId_fkey")
}

model StockMove {
  id               Int                @id @default(autoincrement())
  companyId        Int
  locationId       Int                @map("warehouseId")
  itemId           Int
  date             DateTime
  type             StockMoveType
  direction        StockMoveDirection
  quantity         Decimal            @db.Decimal(18, 2)
  unitCostApplied  Decimal            @db.Decimal(18, 2)
  totalCostApplied Decimal            @db.Decimal(18, 2)
  referenceType    String?
  referenceId      String?
  correlationId    String?
  createdByUserId  Int?
  journalEntryId   Int?
  createdAt        DateTime           @default(now())
  company          Company            @relation(fields: [companyId], references: [id])
  item             Item               @relation(fields: [itemId], references: [id])
  location         Location           @relation(fields: [locationId], references: [id])

  @@index([companyId, date])
  @@index([companyId, itemId])
  @@index([companyId, locationId])
  @@index([itemId], map: "StockMove_itemId_fkey")
  @@index([locationId], map: "StockMove_warehouseId_fkey")
}

model Invoice {
  id                           Int                          @id @default(autoincrement())
  companyId                    Int
  customerId                   Int
  invoiceNumber                String
  status                       InvoiceStatus
  invoiceDate                  DateTime
  dueDate                      DateTime?
  currency                     String?
  total                        Decimal                      @db.Decimal(18, 2)
  journalEntryId               Int?                         @unique
  createdAt                    DateTime                     @default(now())
  updatedAt                    DateTime                     @updatedAt
  amountPaid                   Decimal                      @default(0.00) @db.Decimal(18, 2)
  customerNotes                String?                      @db.Text
  termsAndConditions           String?                      @db.Text
  subtotal                     Decimal                      @default(0.00) @db.Decimal(18, 2)
  taxAmount                    Decimal                      @default(0.00) @db.Decimal(18, 2)
  voidedAt                     DateTime?
  voidReason                   String?                      @db.Text
  voidedByUserId               Int?
  voidJournalEntryId           Int?                         @unique
  lastAdjustmentJournalEntryId Int?
  updatedByUserId              Int?
  locationId                   Int?                         @map("warehouseId")
  pendingPaymentProofs         Json?
  appliedCreditNotes           CreditNote[]                 @relation("CreditNote_AppliedInvoice")
  creditNotes                  CreditNote[]                 @relation("CreditNote_SourceInvoice")
  customerAdvanceApplications  CustomerAdvanceApplication[]
  location                     Location?                    @relation(fields: [locationId], references: [id], map: "Inv_wh_fk")
  company                      Company                      @relation(fields: [companyId], references: [id])
  customer                     Customer                     @relation(fields: [customerId], references: [id])
  journalEntry                 JournalEntry?                @relation("Invoice_JournalEntry", fields: [journalEntryId], references: [id])
  lastAdjustmentJournalEntry   JournalEntry?                @relation("Invoice_LastAdjustmentJournalEntry", fields: [lastAdjustmentJournalEntryId], references: [id])
  updatedByUser                User?                        @relation("User_UpdatedInvoices", fields: [updatedByUserId], references: [id])
  voidJournalEntry             JournalEntry?                @relation("Invoice_VoidJournalEntry", fields: [voidJournalEntryId], references: [id])
  voidedByUser                 User?                        @relation("User_VoidedInvoices", fields: [voidedByUserId], references: [id])
  lines                        InvoiceLine[]
  payments                     Payment[]

  @@unique([companyId, invoiceNumber])
  @@index([companyId, invoiceDate])
  @@index([companyId, status])
  @@index([companyId, locationId], map: "Inv_co_wh_idx")
  @@index([locationId], map: "Inv_wh_idx")
  @@index([customerId], map: "Invoice_customerId_fkey")
  @@index([lastAdjustmentJournalEntryId], map: "Invoice_lastAdjustmentJournalEntryId_fkey")
  @@index([updatedByUserId], map: "Invoice_updatedByUserId_fkey")
  @@index([voidedByUserId], map: "Invoice_voidedByUserId_fkey")
}

model CreditNote {
  id                           Int                @id @default(autoincrement())
  companyId                    Int
  invoiceId                    Int?
  customerId                   Int
  creditNoteNumber             String
  status                       CreditNoteStatus
  creditNoteDate               DateTime
  currency                     String?
  total                        Decimal            @db.Decimal(18, 2)
  journalEntryId               Int?               @unique
  createdAt                    DateTime           @default(now())
  updatedAt                    DateTime           @updatedAt
  subtotal                     Decimal            @default(0.00) @db.Decimal(18, 2)
  taxAmount                    Decimal            @default(0.00) @db.Decimal(18, 2)
  customerNotes                String?            @db.Text
  termsAndConditions           String?            @db.Text
  voidedAt                     DateTime?
  voidReason                   String?            @db.Text
  voidedByUserId               Int?
  voidJournalEntryId           Int?               @unique
  lastAdjustmentJournalEntryId Int?
  updatedByUserId              Int?
  appliedInvoiceId             Int?
  amountRefunded               Decimal            @default(0.00) @db.Decimal(18, 2)
  appliedInvoice               Invoice?           @relation("CreditNote_AppliedInvoice", fields: [appliedInvoiceId], references: [id])
  company                      Company            @relation(fields: [companyId], references: [id])
  customer                     Customer           @relation(fields: [customerId], references: [id])
  invoice                      Invoice?           @relation("CreditNote_SourceInvoice", fields: [invoiceId], references: [id])
  journalEntry                 JournalEntry?      @relation("CreditNote_JournalEntry", fields: [journalEntryId], references: [id])
  lastAdjustmentJournalEntry   JournalEntry?      @relation("CreditNote_LastAdjustmentJournalEntry", fields: [lastAdjustmentJournalEntryId], references: [id])
  updatedByUser                User?              @relation("User_UpdatedCreditNotes", fields: [updatedByUserId], references: [id])
  voidJournalEntry             JournalEntry?      @relation("CreditNote_VoidJournalEntry", fields: [voidJournalEntryId], references: [id])
  voidedByUser                 User?              @relation("User_VoidedCreditNotes", fields: [voidedByUserId], references: [id])
  lines                        CreditNoteLine[]
  refunds                      CreditNoteRefund[]

  @@unique([companyId, creditNoteNumber])
  @@index([companyId, creditNoteDate])
  @@index([companyId, status])
  @@index([companyId, invoiceId])
  @@index([companyId, appliedInvoiceId])
  @@index([appliedInvoiceId])
  @@index([customerId], map: "CreditNote_customerId_fkey")
  @@index([invoiceId], map: "CreditNote_invoiceId_fkey")
  @@index([lastAdjustmentJournalEntryId], map: "CreditNote_lastAdjustmentJournalEntryId_fkey")
  @@index([updatedByUserId], map: "CreditNote_updatedByUserId_fkey")
  @@index([voidedByUserId], map: "CreditNote_voidedByUserId_fkey")
}

model CreditNoteRefund {
  id              Int           @id @default(autoincrement())
  companyId       Int
  creditNoteId    Int
  refundDate      DateTime
  amount          Decimal       @db.Decimal(18, 2)
  bankAccountId   Int
  journalEntryId  Int?          @unique
  reference       String?
  description     String?       @db.Text
  createdByUserId Int?
  createdAt       DateTime      @default(now())
  bankAccount     Account       @relation("CreditNoteRefund_BankAccount", fields: [bankAccountId], references: [id])
  company         Company       @relation(fields: [companyId], references: [id])
  createdByUser   User?         @relation("User_CreatedCreditNoteRefunds", fields: [createdByUserId], references: [id])
  creditNote      CreditNote    @relation(fields: [creditNoteId], references: [id])
  journalEntry    JournalEntry? @relation("CreditNoteRefund_JournalEntry", fields: [journalEntryId], references: [id])

  @@index([companyId, refundDate])
  @@index([companyId, creditNoteId])
  @@index([bankAccountId], map: "CreditNoteRefund_bankAccountId_fkey")
  @@index([createdByUserId], map: "CreditNoteRefund_createdByUserId_fkey")
  @@index([creditNoteId], map: "CreditNoteRefund_creditNoteId_fkey")
}

model CreditNoteLine {
  id              Int          @id @default(autoincrement())
  companyId       Int
  creditNoteId    Int
  invoiceLineId   Int?
  itemId          Int?
  description     String?
  quantity        Decimal      @db.Decimal(18, 2)
  unitPrice       Decimal      @db.Decimal(18, 2)
  lineTotal       Decimal      @db.Decimal(18, 2)
  taxRate         Decimal?     @db.Decimal(5, 4)
  taxAmount       Decimal      @default(0.00) @db.Decimal(18, 2)
  incomeAccountId Int?
  discountAmount  Decimal      @default(0.00) @db.Decimal(18, 2)
  company         Company      @relation(fields: [companyId], references: [id])
  creditNote      CreditNote   @relation(fields: [creditNoteId], references: [id])
  incomeAccount   Account?     @relation("CreditNoteLine_IncomeAccount", fields: [incomeAccountId], references: [id])
  invoiceLine     InvoiceLine? @relation(fields: [invoiceLineId], references: [id])
  item            Item?        @relation(fields: [itemId], references: [id])

  @@index([companyId])
  @@index([creditNoteId])
  @@index([invoiceLineId])
  @@index([incomeAccountId])
  @@index([itemId], map: "CreditNoteLine_itemId_fkey")
}

model InvoiceLine {
  id              Int              @id @default(autoincrement())
  invoiceId       Int
  itemId          Int?
  description     String?
  quantity        Decimal          @db.Decimal(18, 2)
  unitPrice       Decimal          @db.Decimal(18, 2)
  lineTotal       Decimal          @db.Decimal(18, 2)
  taxRate         Decimal?         @db.Decimal(5, 4)
  companyId       Int
  taxAmount       Decimal          @default(0.00) @db.Decimal(18, 2)
  incomeAccountId Int?
  discountAmount  Decimal          @default(0.00) @db.Decimal(18, 2)
  creditNoteLines CreditNoteLine[]
  company         Company          @relation(fields: [companyId], references: [id])
  incomeAccount   Account?         @relation("InvoiceLine_IncomeAccount", fields: [incomeAccountId], references: [id])
  invoice         Invoice          @relation(fields: [invoiceId], references: [id])
  item            Item?            @relation(fields: [itemId], references: [id])

  @@index([companyId])
  @@index([incomeAccountId])
  @@index([invoiceId], map: "InvoiceLine_invoiceId_fkey")
  @@index([itemId], map: "InvoiceLine_itemId_fkey")
}

model Payment {
  id                     Int           @id @default(autoincrement())
  companyId              Int
  invoiceId              Int
  paymentDate            DateTime
  amount                 Decimal       @db.Decimal(18, 2)
  bankAccountId          Int
  journalEntryId         Int?          @unique
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  reversedAt             DateTime?
  reversalReason         String?       @db.Text
  reversalJournalEntryId Int?          @unique
  reversedByUserId       Int?
  attachmentUrl          String?       @db.Text
  bankAccount            Account       @relation("Payment_BankAccount", fields: [bankAccountId], references: [id])
  company                Company       @relation(fields: [companyId], references: [id])
  invoice                Invoice       @relation(fields: [invoiceId], references: [id])
  journalEntry           JournalEntry? @relation("Payment_JournalEntry", fields: [journalEntryId], references: [id])
  reversalJournalEntry   JournalEntry? @relation("Payment_ReversalJournalEntry", fields: [reversalJournalEntryId], references: [id])
  reversedByUser         User?         @relation("User_ReversedPayments", fields: [reversedByUserId], references: [id])

  @@index([companyId, paymentDate])
  @@index([invoiceId])
  @@index([bankAccountId], map: "Payment_bankAccountId_fkey")
  @@index([reversedByUserId], map: "Payment_reversedByUserId_fkey")
}

model Vendor {
  id             Int             @id @default(autoincrement())
  companyId      Int
  name           String
  email          String?
  phone          String?
  currency       String?         @db.VarChar(3)
  openingBalance Decimal?        @db.Decimal(18, 2)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  expenses       Expense[]
  purchaseBills  PurchaseBill[]
  purchaseOrders PurchaseOrder[]
  purchaseReceipts PurchaseReceipt[]
  company        Company         @relation(fields: [companyId], references: [id])
  vendorAdvances VendorAdvance[]
  vendorCredits  VendorCredit[]

  @@index([companyId])
}

model PurchaseBill {
  id                           Int                        @id @default(autoincrement())
  companyId                    Int
  vendorId                     Int?
  locationId                   Int                        @map("warehouseId")
  billNumber                   String
  status                       PurchaseBillStatus
  billDate                     DateTime
  dueDate                      DateTime?
  currency                     String?
  total                        Decimal                    @db.Decimal(18, 2)
  amountPaid                   Decimal                    @default(0.00) @db.Decimal(18, 2)
  journalEntryId               Int?                       @unique
  createdAt                    DateTime                   @default(now())
  updatedAt                    DateTime                   @updatedAt
  voidedAt                     DateTime?
  voidReason                   String?                    @db.Text
  voidedByUserId               Int?
  voidJournalEntryId           Int?                       @unique
  lastAdjustmentJournalEntryId Int?
  updatedByUserId              Int?
  purchaseReceiptId            Int?                       @unique
  company                      Company                    @relation(fields: [companyId], references: [id])
  journalEntry                 JournalEntry?              @relation(fields: [journalEntryId], references: [id])
  lastAdjustmentJournalEntry   JournalEntry?              @relation("PurchaseBill_LastAdjustmentJournalEntry", fields: [lastAdjustmentJournalEntryId], references: [id])
  updatedByUser                User?                      @relation("User_UpdatedPurchaseBills", fields: [updatedByUserId], references: [id])
  vendor                       Vendor?                    @relation(fields: [vendorId], references: [id])
  voidJournalEntry             JournalEntry?              @relation("PurchaseBill_VoidJournalEntry", fields: [voidJournalEntryId], references: [id])
  voidedByUser                 User?                      @relation("User_VoidedPurchaseBills", fields: [voidedByUserId], references: [id])
  location                     Location                   @relation(fields: [locationId], references: [id])
  purchaseReceipt              PurchaseReceipt?           @relation("PurchaseBill_PurchaseReceipt", fields: [purchaseReceiptId], references: [id])
  lines                        PurchaseBillLine[]
  landedCostAllocations        PurchaseBillLandedCostAllocation[]
  payments                     PurchaseBillPayment[]
  vendorAdvanceApplications    VendorAdvanceApplication[]
  creditApplications           VendorCreditApplication[]

  @@unique([companyId, billNumber])
  @@index([companyId, billDate])
  @@index([companyId, status])
  @@index([lastAdjustmentJournalEntryId], map: "PurchaseBill_lastAdjustmentJournalEntryId_fkey")
  @@index([updatedByUserId], map: "PurchaseBill_updatedByUserId_fkey")
  @@index([vendorId], map: "PurchaseBill_vendorId_fkey")
  @@index([voidedByUserId], map: "PurchaseBill_voidedByUserId_fkey")
  @@index([locationId], map: "PurchaseBill_warehouseId_fkey")
  @@index([purchaseReceiptId])
}

model PurchaseBillLandedCostAllocation {
  id                   Int               @id @default(autoincrement())
  companyId             Int
  purchaseBillId        Int
  purchaseReceiptId     Int
  purchaseReceiptLineId Int
  amount                Decimal           @db.Decimal(18, 2)
  createdAt             DateTime          @default(now())

  company              Company            @relation(fields: [companyId], references: [id])
  purchaseBill         PurchaseBill       @relation(fields: [purchaseBillId], references: [id], onDelete: Cascade)
  purchaseReceipt      PurchaseReceipt     @relation(fields: [purchaseReceiptId], references: [id], onDelete: Cascade)
  purchaseReceiptLine  PurchaseReceiptLine @relation(fields: [purchaseReceiptLineId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([purchaseBillId])
  @@index([purchaseReceiptId])
  @@index([purchaseReceiptLineId])
}

enum PurchaseReceiptStatus {
  DRAFT
  POSTED
  VOID
}

model PurchaseReceipt {
  id               Int                 @id @default(autoincrement())
  companyId         Int
  vendorId          Int?
  purchaseOrderId   Int?
  locationId        Int                 @map("warehouseId")
  receiptNumber     String
  status            PurchaseReceiptStatus
  receiptDate       DateTime
  expectedDate      DateTime?
  currency          String?             @db.VarChar(3)
  total             Decimal             @db.Decimal(18, 2)
  journalEntryId    Int?                @unique
  voidJournalEntryId Int?               @unique
  voidedAt          DateTime?
  voidReason        String?             @db.Text
  createdByUserId   Int?
  updatedByUserId   Int?
  voidedByUserId    Int?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  company        Company            @relation(fields: [companyId], references: [id])
  vendor         Vendor?            @relation(fields: [vendorId], references: [id])
  purchaseOrder  PurchaseOrder?     @relation(fields: [purchaseOrderId], references: [id])
  location       Location           @relation(fields: [locationId], references: [id])
  journalEntry   JournalEntry?      @relation("PurchaseReceipt_JournalEntry", fields: [journalEntryId], references: [id])
  voidJournalEntry JournalEntry?    @relation("PurchaseReceipt_VoidJournalEntry", fields: [voidJournalEntryId], references: [id])
  lines          PurchaseReceiptLine[]
  billedBy       PurchaseBill?      @relation("PurchaseBill_PurchaseReceipt")
  landedCostAllocations PurchaseBillLandedCostAllocation[]

  @@unique([companyId, receiptNumber])
  @@index([companyId, receiptDate])
  @@index([companyId, status])
  @@index([vendorId])
  @@index([purchaseOrderId])
  @@index([locationId], map: "PurchaseReceipt_warehouseId_fkey")
}

model PurchaseReceiptLine {
  id               Int             @id @default(autoincrement())
  companyId        Int
  purchaseReceiptId Int
  locationId       Int             @map("warehouseId")
  itemId           Int
  purchaseOrderLineId Int?
  description      String?
  quantity         Decimal         @db.Decimal(18, 2)
  unitCost         Decimal         @db.Decimal(18, 2)
  discountAmount   Decimal         @default(0.00) @db.Decimal(18, 2)
  lineTotal        Decimal         @db.Decimal(18, 2)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  company         Company         @relation(fields: [companyId], references: [id])
  purchaseReceipt PurchaseReceipt @relation(fields: [purchaseReceiptId], references: [id], onDelete: Cascade)
  purchaseOrderLine PurchaseOrderLine? @relation(fields: [purchaseOrderLineId], references: [id], onDelete: SetNull)
  item            Item            @relation(fields: [itemId], references: [id])
  location        Location        @relation(fields: [locationId], references: [id])
  landedCostAllocations PurchaseBillLandedCostAllocation[]

  @@index([companyId])
  @@index([purchaseReceiptId])
  @@index([companyId, itemId])
  @@index([purchaseOrderLineId])
  @@index([itemId], map: "PurchaseReceiptLine_itemId_fkey")
  @@index([locationId], map: "PurchaseReceiptLine_warehouseId_fkey")
}

model VendorAdvance {
  id                  Int                        @id @default(autoincrement())
  companyId           Int
  vendorId            Int
  locationId          Int                        @map("warehouseId")
  advanceDate         DateTime
  currency            String?
  amount              Decimal                    @db.Decimal(18, 2)
  amountApplied       Decimal                    @default(0.00) @db.Decimal(18, 2)
  bankAccountId       Int
  prepaymentAccountId Int
  receivedVia         BankingAccountKind?
  reference           String?
  description         String?                    @db.Text
  journalEntryId      Int?                       @unique
  createdByUserId     Int?
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  bankAccount         Account                    @relation("VendorAdvance_BankAccount", fields: [bankAccountId], references: [id])
  company             Company                    @relation(fields: [companyId], references: [id])
  createdByUser       User?                      @relation("User_CreatedVendorAdvances", fields: [createdByUserId], references: [id])
  journalEntry        JournalEntry?              @relation("VendorAdvance_JournalEntry", fields: [journalEntryId], references: [id])
  prepaymentAccount   Account                    @relation("VendorAdvance_PrepaymentAccount", fields: [prepaymentAccountId], references: [id])
  vendor              Vendor                     @relation(fields: [vendorId], references: [id])
  location            Location                   @relation(fields: [locationId], references: [id])
  applications        VendorAdvanceApplication[]

  @@index([companyId, advanceDate])
  @@index([companyId, vendorId])
  @@index([bankAccountId], map: "VendorAdvance_bankAccountId_fkey")
  @@index([createdByUserId], map: "VendorAdvance_createdByUserId_fkey")
  @@index([prepaymentAccountId], map: "VendorAdvance_prepaymentAccountId_fkey")
  @@index([vendorId], map: "VendorAdvance_vendorId_fkey")
  @@index([locationId], map: "VendorAdvance_warehouseId_fkey")
}

model VendorAdvanceApplication {
  id              Int           @id @default(autoincrement())
  companyId       Int
  vendorAdvanceId Int
  purchaseBillId  Int
  appliedDate     DateTime
  amount          Decimal       @db.Decimal(18, 2)
  journalEntryId  Int?          @unique
  createdByUserId Int?
  createdAt       DateTime      @default(now())
  company         Company       @relation(fields: [companyId], references: [id])
  createdByUser   User?         @relation("User_CreatedVendorAdvanceApplications", fields: [createdByUserId], references: [id])
  journalEntry    JournalEntry? @relation("VendorAdvanceApplication_JournalEntry", fields: [journalEntryId], references: [id])
  purchaseBill    PurchaseBill  @relation(fields: [purchaseBillId], references: [id])
  vendorAdvance   VendorAdvance @relation(fields: [vendorAdvanceId], references: [id])

  @@index([companyId, appliedDate])
  @@index([companyId, vendorAdvanceId])
  @@index([companyId, purchaseBillId])
  @@index([createdByUserId], map: "VendorAdvanceApplication_createdByUserId_fkey")
  @@index([purchaseBillId], map: "VendorAdvanceApplication_purchaseBillId_fkey")
  @@index([vendorAdvanceId], map: "VendorAdvanceApplication_vendorAdvanceId_fkey")
}

model VendorCredit {
  id                           Int                       @id @default(autoincrement())
  companyId                    Int
  vendorId                     Int?
  locationId                   Int                       @map("warehouseId")
  creditNumber                 String
  status                       VendorCreditStatus
  creditDate                   DateTime
  currency                     String?
  total                        Decimal                   @db.Decimal(18, 2)
  amountApplied                Decimal                   @default(0.00) @db.Decimal(18, 2)
  journalEntryId               Int?                      @unique
  voidedAt                     DateTime?
  voidReason                   String?                   @db.Text
  voidedByUserId               Int?
  voidJournalEntryId           Int?                      @unique
  lastAdjustmentJournalEntryId Int?
  updatedByUserId              Int?
  createdAt                    DateTime                  @default(now())
  updatedAt                    DateTime                  @updatedAt
  company                      Company                   @relation(fields: [companyId], references: [id])
  journalEntry                 JournalEntry?             @relation("VendorCredit_JournalEntry", fields: [journalEntryId], references: [id])
  lastAdjustmentJournalEntry   JournalEntry?             @relation("VendorCredit_LastAdjustmentJournalEntry", fields: [lastAdjustmentJournalEntryId], references: [id])
  updatedByUser                User?                     @relation("User_UpdatedVendorCredits", fields: [updatedByUserId], references: [id])
  vendor                       Vendor?                   @relation(fields: [vendorId], references: [id])
  voidJournalEntry             JournalEntry?             @relation("VendorCredit_VoidJournalEntry", fields: [voidJournalEntryId], references: [id])
  voidedByUser                 User?                     @relation("User_VoidedVendorCredits", fields: [voidedByUserId], references: [id])
  location                     Location                  @relation("VendorCredit_Location", fields: [locationId], references: [id])
  applications                 VendorCreditApplication[]
  lines                        VendorCreditLine[]

  @@unique([companyId, creditNumber])
  @@index([companyId, creditDate])
  @@index([companyId, status])
  @@index([companyId, vendorId])
  @@index([lastAdjustmentJournalEntryId], map: "VendorCredit_lastAdjustmentJournalEntryId_fkey")
  @@index([updatedByUserId], map: "VendorCredit_updatedByUserId_fkey")
  @@index([vendorId], map: "VendorCredit_vendorId_fkey")
  @@index([voidedByUserId], map: "VendorCredit_voidedByUserId_fkey")
  @@index([locationId], map: "VendorCredit_warehouseId_fkey")
}

model VendorCreditLine {
  id             Int          @id @default(autoincrement())
  companyId      Int
  vendorCreditId Int
  locationId     Int          @map("warehouseId")
  itemId         Int
  accountId      Int?
  description    String?
  quantity       Decimal      @db.Decimal(18, 2)
  unitCost       Decimal      @db.Decimal(18, 2)
  lineTotal      Decimal      @db.Decimal(18, 2)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  account        Account?     @relation("VendorCreditLine_Account", fields: [accountId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id])
  item           Item         @relation(fields: [itemId], references: [id])
  vendorCredit   VendorCredit @relation(fields: [vendorCreditId], references: [id], onDelete: Cascade)
  location       Location     @relation("VendorCreditLine_Location", fields: [locationId], references: [id])

  @@index([companyId])
  @@index([vendorCreditId])
  @@index([companyId, itemId])
  @@index([accountId], map: "VendorCreditLine_accountId_fkey")
  @@index([itemId], map: "VendorCreditLine_itemId_fkey")
  @@index([locationId], map: "VendorCreditLine_warehouseId_fkey")
}

model VendorCreditApplication {
  id              Int          @id @default(autoincrement())
  companyId       Int
  vendorCreditId  Int
  purchaseBillId  Int
  appliedDate     DateTime
  amount          Decimal      @db.Decimal(18, 2)
  createdByUserId Int?
  createdAt       DateTime     @default(now())
  company         Company      @relation(fields: [companyId], references: [id])
  createdByUser   User?        @relation("User_CreatedVendorCreditApplications", fields: [createdByUserId], references: [id])
  purchaseBill    PurchaseBill @relation(fields: [purchaseBillId], references: [id])
  vendorCredit    VendorCredit @relation(fields: [vendorCreditId], references: [id])

  @@index([companyId, appliedDate])
  @@index([companyId, vendorCreditId])
  @@index([companyId, purchaseBillId])
  @@index([createdByUserId], map: "VendorCreditApplication_createdByUserId_fkey")
  @@index([purchaseBillId], map: "VendorCreditApplication_purchaseBillId_fkey")
  @@index([vendorCreditId], map: "VendorCreditApplication_vendorCreditId_fkey")
}

model CustomerAdvance {
  id                 Int                          @id @default(autoincrement())
  companyId          Int
  customerId         Int
  locationId         Int                          @map("warehouseId")
  advanceDate        DateTime
  currency           String?
  amount             Decimal                      @db.Decimal(18, 2)
  amountApplied      Decimal                      @default(0.00) @db.Decimal(18, 2)
  bankAccountId      Int
  liabilityAccountId Int
  receivedVia        BankingAccountKind?
  reference          String?
  description        String?                      @db.Text
  journalEntryId     Int?                         @unique
  createdByUserId    Int?
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  bankAccount        Account                      @relation("CustomerAdvance_BankAccount", fields: [bankAccountId], references: [id])
  company            Company                      @relation(fields: [companyId], references: [id])
  createdByUser      User?                        @relation("User_CreatedCustomerAdvances", fields: [createdByUserId], references: [id])
  customer           Customer                     @relation(fields: [customerId], references: [id])
  journalEntry       JournalEntry?                @relation("CustomerAdvance_JournalEntry", fields: [journalEntryId], references: [id])
  liabilityAccount   Account                      @relation("CustomerAdvance_LiabilityAccount", fields: [liabilityAccountId], references: [id])
  location           Location                     @relation("CustomerAdvance_Location", fields: [locationId], references: [id])
  applications       CustomerAdvanceApplication[]

  @@index([companyId, advanceDate])
  @@index([companyId, customerId])
  @@index([bankAccountId], map: "CustomerAdvance_bankAccountId_fkey")
  @@index([createdByUserId], map: "CustomerAdvance_createdByUserId_fkey")
  @@index([customerId], map: "CustomerAdvance_customerId_fkey")
  @@index([liabilityAccountId], map: "CustomerAdvance_liabilityAccountId_fkey")
  @@index([locationId], map: "CustomerAdvance_warehouseId_fkey")
}

model CustomerAdvanceApplication {
  id                Int             @id @default(autoincrement())
  companyId         Int
  customerAdvanceId Int
  invoiceId         Int
  appliedDate       DateTime
  amount            Decimal         @db.Decimal(18, 2)
  journalEntryId    Int?            @unique
  createdByUserId   Int?
  createdAt         DateTime        @default(now())
  company           Company         @relation(fields: [companyId], references: [id])
  createdByUser     User?           @relation("User_CreatedCustomerAdvanceApplications", fields: [createdByUserId], references: [id])
  customerAdvance   CustomerAdvance @relation(fields: [customerAdvanceId], references: [id])
  invoice           Invoice         @relation(fields: [invoiceId], references: [id])
  journalEntry      JournalEntry?   @relation("CustomerAdvanceApplication_JournalEntry", fields: [journalEntryId], references: [id])

  @@index([companyId, appliedDate])
  @@index([companyId, customerAdvanceId])
  @@index([companyId, invoiceId])
  @@index([createdByUserId], map: "CustomerAdvanceApplication_createdByUserId_fkey")
  @@index([customerAdvanceId], map: "CustomerAdvanceApplication_customerAdvanceId_fkey")
  @@index([invoiceId], map: "CustomerAdvanceApplication_invoiceId_fkey")
}

model PurchaseBillLine {
  id             Int          @id @default(autoincrement())
  companyId      Int
  purchaseBillId Int
  locationId     Int          @map("warehouseId")
  itemId         Int
  description    String?
  quantity       Decimal      @db.Decimal(18, 2)
  unitCost       Decimal      @db.Decimal(18, 2)
  discountAmount Decimal      @default(0.00) @db.Decimal(18, 2)
  lineTotal      Decimal      @db.Decimal(18, 2)
  accountId      Int?
  account        Account?     @relation(fields: [accountId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id])
  item           Item         @relation(fields: [itemId], references: [id])
  purchaseBill   PurchaseBill @relation(fields: [purchaseBillId], references: [id])
  location       Location     @relation(fields: [locationId], references: [id])

  @@index([companyId])
  @@index([purchaseBillId])
  @@index([companyId, itemId])
  @@index([accountId])
  @@index([itemId], map: "PurchaseBillLine_itemId_fkey")
  @@index([locationId], map: "PurchaseBillLine_warehouseId_fkey")
}

model PurchaseBillPayment {
  id                     Int           @id @default(autoincrement())
  companyId              Int
  purchaseBillId         Int
  paymentDate            DateTime
  amount                 Decimal       @db.Decimal(18, 2)
  bankAccountId          Int
  journalEntryId         Int?          @unique
  reversedAt             DateTime?
  reversalReason         String?       @db.Text
  reversalJournalEntryId Int?          @unique
  reversedByUserId       Int?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  bankAccount            Account       @relation("PurchaseBillPayment_BankAccount", fields: [bankAccountId], references: [id])
  company                Company       @relation(fields: [companyId], references: [id])
  journalEntry           JournalEntry? @relation("PurchaseBillPayment_JournalEntry", fields: [journalEntryId], references: [id])
  purchaseBill           PurchaseBill  @relation(fields: [purchaseBillId], references: [id])
  reversalJournalEntry   JournalEntry? @relation("PurchaseBillPayment_ReversalJournalEntry", fields: [reversalJournalEntryId], references: [id])
  reversedByUser         User?         @relation(fields: [reversedByUserId], references: [id])

  @@index([companyId, paymentDate])
  @@index([purchaseBillId])
  @@index([bankAccountId], map: "PurchaseBillPayment_bankAccountId_fkey")
  @@index([reversedByUserId], map: "PurchaseBillPayment_reversedByUserId_fkey")
}

model Expense {
  id                           Int              @id @default(autoincrement())
  companyId                    Int
  expenseNumber                String
  status                       ExpenseStatus
  expenseDate                  DateTime
  description                  String
  amount                       Decimal          @db.Decimal(18, 2)
  currency                     String?
  itemId                       Int?
  journalEntryId               Int?             @unique
  createdAt                    DateTime         @default(now())
  updatedAt                    DateTime         @updatedAt
  vendorId                     Int?
  dueDate                      DateTime?
  amountPaid                   Decimal          @default(0.00) @db.Decimal(18, 2)
  expenseAccountId             Int?
  voidedAt                     DateTime?
  voidReason                   String?          @db.Text
  voidedByUserId               Int?
  voidJournalEntryId           Int?             @unique
  lastAdjustmentJournalEntryId Int?
  updatedByUserId              Int?
  attachmentUrl                String?          @db.Text
  company                      Company          @relation(fields: [companyId], references: [id])
  expenseAccount               Account?         @relation("Expense_ExpenseAccount", fields: [expenseAccountId], references: [id])
  item                         Item?            @relation(fields: [itemId], references: [id])
  journalEntry                 JournalEntry?    @relation("Expense_JournalEntry", fields: [journalEntryId], references: [id])
  lastAdjustmentJournalEntry   JournalEntry?    @relation("Expense_LastAdjustmentJournalEntry", fields: [lastAdjustmentJournalEntryId], references: [id])
  updatedByUser                User?            @relation("User_UpdatedExpenses", fields: [updatedByUserId], references: [id])
  vendor                       Vendor?          @relation(fields: [vendorId], references: [id])
  voidJournalEntry             JournalEntry?    @relation("Expense_VoidJournalEntry", fields: [voidJournalEntryId], references: [id])
  voidedByUser                 User?            @relation("User_VoidedExpenses", fields: [voidedByUserId], references: [id])
  payments                     ExpensePayment[]

  @@unique([companyId, expenseNumber])
  @@index([companyId, expenseDate])
  @@index([companyId, status])
  @@index([expenseAccountId])
  @@index([itemId], map: "Expense_itemId_fkey")
  @@index([lastAdjustmentJournalEntryId], map: "Expense_lastAdjustmentJournalEntryId_fkey")
  @@index([updatedByUserId], map: "Expense_updatedByUserId_fkey")
  @@index([vendorId])
  @@index([voidedByUserId], map: "Expense_voidedByUserId_fkey")
}

model ExpensePayment {
  id                     Int           @id @default(autoincrement())
  companyId              Int
  expenseId              Int
  paymentDate            DateTime
  amount                 Decimal       @db.Decimal(18, 2)
  bankAccountId          Int
  journalEntryId         Int?          @unique
  reversedAt             DateTime?
  reversalReason         String?       @db.Text
  reversalJournalEntryId Int?          @unique
  reversedByUserId       Int?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  bankAccount            Account       @relation("ExpensePayment_BankAccount", fields: [bankAccountId], references: [id])
  company                Company       @relation(fields: [companyId], references: [id])
  expense                Expense       @relation(fields: [expenseId], references: [id])
  journalEntry           JournalEntry? @relation("ExpensePayment_JournalEntry", fields: [journalEntryId], references: [id])
  reversalJournalEntry   JournalEntry? @relation("ExpensePayment_ReversalJournalEntry", fields: [reversalJournalEntryId], references: [id])
  reversedByUser         User?         @relation("User_ReversedExpensePayments", fields: [reversedByUserId], references: [id])

  @@index([companyId, paymentDate])
  @@index([expenseId])
  @@index([bankAccountId], map: "ExpensePayment_bankAccountId_fkey")
  @@index([reversedByUserId], map: "ExpensePayment_reversedByUserId_fkey")
}

model User {
  id                                 Int                          @id @default(autoincrement())
  email                              String                       @unique
  password                           String
  name                               String?
  companyId                          Int
  createdAt                          DateTime                     @default(now())
  updatedAt                          DateTime                     @updatedAt
  role                               UserRole                     @default(OWNER)
  phone                              String?                      @unique @db.VarChar(32)
  phoneVerifiedAt                    DateTime?
  auditLogs                          AuditLog[]
  updatedCreditNotes                 CreditNote[]                 @relation("User_UpdatedCreditNotes")
  voidedCreditNotes                  CreditNote[]                 @relation("User_VoidedCreditNotes")
  creditNoteRefundsCreated           CreditNoteRefund[]           @relation("User_CreatedCreditNoteRefunds")
  customerAdvancesCreated            CustomerAdvance[]            @relation("User_CreatedCustomerAdvances")
  customerAdvanceApplicationsCreated CustomerAdvanceApplication[] @relation("User_CreatedCustomerAdvanceApplications")
  updatedExpenses                    Expense[]                    @relation("User_UpdatedExpenses")
  voidedExpenses                     Expense[]                    @relation("User_VoidedExpenses")
  reversedExpensePayments            ExpensePayment[]             @relation("User_ReversedExpensePayments")
  updatedInvoices                    Invoice[]                    @relation("User_UpdatedInvoices")
  voidedInvoices                     Invoice[]                    @relation("User_VoidedInvoices")
  journalEntriesCreated              JournalEntry[]
  updatedJournalEntries              JournalEntry[]               @relation("User_UpdatedJournalEntries")
  voidedJournalEntries               JournalEntry[]               @relation("User_VoidedJournalEntries")
  reversedPayments                   Payment[]                    @relation("User_ReversedPayments")
  periodClosesCreated                PeriodClose[]                @relation("User_PeriodClosesCreated")
  updatedPurchaseBills               PurchaseBill[]               @relation("User_UpdatedPurchaseBills")
  voidedPurchaseBills                PurchaseBill[]               @relation("User_VoidedPurchaseBills")
  reversedPurchaseBillPayments       PurchaseBillPayment[]
  company                            Company                      @relation(fields: [companyId], references: [id])
  vendorAdvancesCreated              VendorAdvance[]              @relation("User_CreatedVendorAdvances")
  vendorAdvanceApplicationsCreated   VendorAdvanceApplication[]   @relation("User_CreatedVendorAdvanceApplications")
  updatedVendorCredits               VendorCredit[]               @relation("User_UpdatedVendorCredits")
  voidedVendorCredits                VendorCredit[]               @relation("User_VoidedVendorCredits")
  vendorCreditApplicationsCreated    VendorCreditApplication[]    @relation("User_CreatedVendorCreditApplications")

  @@index([companyId])
}

model LoginOtp {
  id          Int       @id @default(autoincrement())
  phone       String    @db.VarChar(32)
  codeHash    String
  purpose     String    @db.VarChar(32)
  expiresAt   DateTime
  consumedAt  DateTime?
  attempts    Int       @default(0)
  requestedIp String?   @db.VarChar(64)
  verifiedIp  String?   @db.VarChar(64)
  createdAt   DateTime  @default(now())

  @@index([phone, purpose, createdAt])
  @@index([phone, purpose, expiresAt])
}

model AuditLog {
  id             Int      @id @default(autoincrement())
  companyId      Int
  userId         Int?
  action         String
  entityType     String
  entityId       String?
  idempotencyKey String?
  correlationId  String?
  metadata       Json?
  createdAt      DateTime @default(now())
  company        Company  @relation(fields: [companyId], references: [id])
  user           User?    @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt])
  @@index([companyId, entityType, entityId])
  @@index([companyId, userId, createdAt])
  @@index([userId], map: "AuditLog_userId_fkey")
}

model PeriodClose {
  id              Int          @id @default(autoincrement())
  companyId       Int
  fromDate        DateTime
  toDate          DateTime
  journalEntryId  Int          @unique
  createdByUserId Int?
  createdAt       DateTime     @default(now())
  company         Company      @relation(fields: [companyId], references: [id])
  createdByUser   User?        @relation("User_PeriodClosesCreated", fields: [createdByUserId], references: [id])
  journalEntry    JournalEntry @relation(fields: [journalEntryId], references: [id])

  @@unique([companyId, fromDate, toDate])
  @@index([companyId, toDate])
  @@index([createdByUserId], map: "PeriodClose_createdByUserId_fkey")
}

// --- Backdated inventory recalculation state (per company) ---
// Coalesces repeated "recalc requested" events into a single cursor.
model InventoryRecalcState {
  companyId         Int      @id
  requestedFromDate DateTime?
  requestedAt       DateTime?
  runningAt         DateTime?
  lockedAt          DateTime?
  lockId            String?  @db.VarChar(64)
  attempts          Int      @default(0)
  lastError         String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([requestedAt])
  @@index([runningAt])
  @@index([lockedAt])
}

// Tracks the net COGS/inventory adjustment applied by the inventory revaluation pipeline
// for a given source journal entry. This makes revaluation idempotent across retries.
model JournalEntryInventoryValuation {
  id                 Int      @id @default(autoincrement())
  companyId           Int
  sourceJournalEntryId Int
  lastComputedCogs    Decimal  @default(0.00) @db.Decimal(18, 2)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sourceJournalEntry JournalEntry @relation(fields: [sourceJournalEntryId], references: [id], onDelete: Restrict)

  @@unique([companyId, sourceJournalEntryId], map: "JEIV_uq")
  @@index([companyId], map: "JEIV_companyId_idx")
  @@index([sourceJournalEntryId], map: "JEIV_sourceJeId_idx")
}

model IdempotentRequest {
  id        Int      @id @default(autoincrement())
  companyId Int
  key       String
  response  Json
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@index([companyId, createdAt])
}

model DocumentSequence {
  id         Int      @id @default(autoincrement())
  companyId  Int
  key        String
  nextNumber Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  company    Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@index([companyId])
}

model TaxRate {
  id               Int              @id @default(autoincrement())
  companyId        Int
  name             String
  rate             Decimal          @db.Decimal(5, 4)
  isCompound       Boolean          @default(false)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  groupMemberships TaxGroupMember[]
  company          Company          @relation(fields: [companyId], references: [id])

  @@unique([companyId, name])
  @@index([companyId])
}

model TaxGroup {
  id        Int              @id @default(autoincrement())
  companyId Int
  name      String
  totalRate Decimal          @db.Decimal(5, 4)
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  company   Company          @relation(fields: [companyId], references: [id])
  members   TaxGroupMember[]

  @@unique([companyId, name])
  @@index([companyId])
}

model TaxGroupMember {
  id        Int      @id @default(autoincrement())
  groupId   Int
  taxRateId Int
  createdAt DateTime @default(now())
  group     TaxGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  taxRate   TaxRate  @relation(fields: [taxRateId], references: [id], onDelete: Cascade)

  @@unique([groupId, taxRateId])
  @@index([groupId])
  @@index([taxRateId])
}

model IntegrationEntityMap {
  id          Int      @id @default(autoincrement())
  companyId   Int
  integration String   @db.VarChar(32)
  entityType  String   @db.VarChar(32)
  externalId  String   @db.VarChar(128)
  internalId  String   @db.VarChar(128)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], map: "IEM_companyId_fkey")

  @@unique([companyId, integration, entityType, externalId], map: "IEM_uq")
  @@index([companyId, integration, entityType], map: "IEM_idx")
}

model Currency {
  id            Int            @id @default(autoincrement())
  companyId     Int
  code          String         @db.VarChar(3)
  name          String?
  symbol        String?        @db.VarChar(16)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  exchangeRates ExchangeRate[]

  @@unique([companyId, code])
  @@index([companyId])
}

model ExchangeRate {
  id           Int      @id @default(autoincrement())
  companyId    Int
  currencyId   Int
  baseCurrency String   @db.VarChar(3)
  rateToBase   Decimal  @db.Decimal(18, 8)
  asOfDate     DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  currency     Currency @relation(fields: [currencyId], references: [id], onDelete: Cascade)

  @@unique([companyId, currencyId, asOfDate])
  @@index([companyId, currencyId, asOfDate])
  @@index([companyId, asOfDate])
  @@index([currencyId], map: "ExchangeRate_currencyId_fkey")
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

enum NormalBalance {
  DEBIT
  CREDIT
}

enum AccountReportGroup {
  CASH_AND_CASH_EQUIVALENTS
  ACCOUNTS_RECEIVABLE
  INVENTORY
  OTHER_CURRENT_ASSET
  FIXED_ASSET
  ACCOUNTS_PAYABLE
  OTHER_CURRENT_LIABILITY
  LONG_TERM_LIABILITY
  EQUITY
  SALES_REVENUE
  OTHER_INCOME
  COGS
  OPERATING_EXPENSE
  OTHER_EXPENSE
  TAX_EXPENSE
}

enum CashflowActivity {
  OPERATING
  INVESTING
  FINANCING
}

enum ItemType {
  GOODS
  SERVICE
}

enum InvoiceStatus {
  DRAFT
  APPROVED
  POSTED
  PAID
  PARTIAL
  VOID
}

enum CreditNoteStatus {
  DRAFT
  APPROVED
  POSTED
  VOID
}

enum ExpenseStatus {
  DRAFT
  APPROVED
  POSTED
  PARTIAL
  PAID
  VOID
}

enum BankingAccountKind {
  CASH
  BANK
  E_WALLET
  CREDIT_CARD
}

enum UserRole {
  OWNER
  ACCOUNTANT
  CLERK
  VIEWER
}

enum InventoryValuationMethod {
  WAC
}

enum StockMoveType {
  OPENING
  ADJUSTMENT
  SALE_ISSUE
  SALE_RETURN
  PURCHASE_RECEIPT
  PURCHASE_RETURN
  TRANSFER_OUT
  TRANSFER_IN
  VALUE_ADJUSTMENT
}

enum StockMoveDirection {
  IN
  OUT
}

enum PurchaseBillStatus {
  DRAFT
  APPROVED
  POSTED
  PARTIAL
  PAID
  VOID
}

enum PurchaseOrderStatus {
  DRAFT
  APPROVED
  CANCELLED
}

model PurchaseOrder {
  id            Int                @id @default(autoincrement())
  companyId     Int
  vendorId      Int?
  locationId    Int                @map("warehouseId")
  poNumber      String
  status        PurchaseOrderStatus
  orderDate     DateTime
  expectedDate  DateTime?
  currency      String?            @db.VarChar(3)
  total         Decimal            @db.Decimal(18, 2)
  notes         String?            @db.Text
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  createdByUserId Int?
  updatedByUserId Int?

  company       Company            @relation(fields: [companyId], references: [id])
  vendor        Vendor?            @relation(fields: [vendorId], references: [id])
  location      Location           @relation(fields: [locationId], references: [id])
  lines         PurchaseOrderLine[]
  purchaseReceipts PurchaseReceipt[]

  @@unique([companyId, poNumber])
  @@index([companyId, orderDate])
  @@index([companyId, status])
  @@index([vendorId], map: "PurchaseOrder_vendorId_fkey")
  @@index([locationId], map: "PurchaseOrder_warehouseId_fkey")
}

model PurchaseOrderLine {
  id              Int          @id @default(autoincrement())
  companyId       Int
  purchaseOrderId Int
  locationId      Int          @map("warehouseId")
  itemId          Int
  description     String?
  quantity        Decimal      @db.Decimal(18, 2)
  unitCost        Decimal      @db.Decimal(18, 2)
  discountAmount  Decimal      @default(0.00) @db.Decimal(18, 2)
  lineTotal       Decimal      @db.Decimal(18, 2)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  company         Company      @relation(fields: [companyId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item            Item         @relation(fields: [itemId], references: [id])
  location        Location     @relation(fields: [locationId], references: [id])
  receiptLines    PurchaseReceiptLine[]

  @@index([companyId])
  @@index([purchaseOrderId])
  @@index([companyId, itemId])
  @@index([itemId], map: "PurchaseOrderLine_itemId_fkey")
  @@index([locationId], map: "PurchaseOrderLine_warehouseId_fkey")
}

enum VendorCreditStatus {
  DRAFT
  APPROVED
  POSTED
  VOID
}

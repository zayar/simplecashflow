generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

model Company {
  id        Int            @id @default(autoincrement())
  name      String
  accounts  Account[]
  entries   JournalEntry[]
  events    Event[]
  summaries DailySummary[] 
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model Account {
  id          Int          @id @default(autoincrement())
  companyId   Int
  company     Company      @relation(fields: [companyId], references: [id])

  code        String       // e.g. "1000", "4100"
  name        String       // e.g. "Cash on Hand"
  type        AccountType
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  lines       JournalLine[]

  @@unique([companyId, code])  // one code per company
}

model JournalEntry {
  id          Int           @id @default(autoincrement())
  companyId   Int
  company     Company       @relation(fields: [companyId], references: [id])

  date        DateTime
  description String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  lines       JournalLine[]
}

model JournalLine {
  id             Int           @id @default(autoincrement())

  journalEntryId Int
  journalEntry   JournalEntry  @relation(fields: [journalEntryId], references: [id])

  accountId      Int
  account        Account       @relation(fields: [accountId], references: [id])

  debit          Decimal       @db.Decimal(18, 2)
  credit         Decimal       @db.Decimal(18, 2)
}

model Event {
  id        Int       @id @default(autoincrement())
  companyId Int?
  company   Company?  @relation(fields: [companyId], references: [id])

  eventId       String   @unique      // same ID we publish to Pub/Sub
  eventType     String               // e.g. "journal.entry.created"
  schemaVersion String               // e.g. "v1"
  occurredAt    DateTime @default(now())
  source        String?              // e.g. "cashflow-api"

  type      String    // e.g. "JournalEntryCreated"
  payload   Json      // flexible JSON payload
  createdAt DateTime  @default(now())
}

model ProcessedEvent {
  id          Int      @id @default(autoincrement())
  eventId     String   @unique
  processedAt DateTime @default(now())
}

model DailySummary {
  id           Int      @id @default(autoincrement())
  companyId    Int
  company      Company  @relation(fields: [companyId], references: [id])
  date         DateTime // we will store "day" (00:00 time) here
  totalIncome  Decimal  @db.Decimal(18, 2)
  totalExpense Decimal  @db.Decimal(18, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([companyId, date])
}